# Git Workflow and Version Control

---
description: Git workflow patterns, conventional commits, and branching strategy
globs: ["**/*.git*", ".git/**"]
alwaysApply: false
---

## Branching Strategy

### Branch Types

| Branch | Purpose | Naming |
|--------|---------|--------|
| `main` | Production-ready code | Protected |
| `develop` | Integration branch | Protected |
| `feature/*` | New features | `feature/add-celtic-cross-spread` |
| `fix/*` | Bug fixes | `fix/reading-save-error` |
| `docs/*` | Documentation only | `docs/update-api-guide` |
| `refactor/*` | Code refactoring | `refactor/extract-card-service` |

### Branch Flow

```
main (production)
  ^
  |
develop (integration)
  ^
  |--- feature/new-feature
  |--- fix/bug-fix
  |--- docs/documentation
```

### Creating Branches

```bash
# Always branch from develop for features
git checkout develop
git pull origin develop
git checkout -b feature/your-feature-name

# For hotfixes, branch from main
git checkout main
git pull origin main
git checkout -b fix/critical-bug
```

## Conventional Commits

### Format

```
type(scope): description

[optional body]

[optional footer]
```

### Types

| Type | Use Case | Example |
|------|----------|---------|
| `feat` | New feature | `feat(reading): add three-card spread` |
| `fix` | Bug fix | `fix(api): handle empty question validation` |
| `docs` | Documentation | `docs(readme): add setup instructions` |
| `style` | Formatting only | `style(api): fix indentation` |
| `refactor` | Code restructuring | `refactor(tarot): extract card draw logic` |
| `test` | Adding tests | `test(reading): add spread validation tests` |
| `chore` | Maintenance | `chore(deps): update fastapi to 0.110` |
| `perf` | Performance | `perf(llm): cache system prompts` |
| `ci` | CI/CD changes | `ci(github): add test workflow` |

### Scopes for Alembic

| Scope | Area |
|-------|------|
| `api` | Backend API endpoints |
| `ui` | Frontend components |
| `tarot` | Tarot-specific logic |
| `llm` | LLM integration |
| `auth` | Authentication |
| `db` | Database/models |
| `stripe` | Payment integration |
| `docs` | Documentation |
| `config` | Configuration |

### Examples

```bash
# Feature with body
git commit -m "feat(tarot): add celtic cross spread

Implements 10-card Celtic Cross layout with proper
position meanings and interpretation prompt."

# Bug fix with issue reference
git commit -m "fix(api): handle missing user gracefully

Closes #42"

# Breaking change
git commit -m "feat(api)!: change reading response format

BREAKING CHANGE: Reading responses now include
card positions as nested objects instead of flat array."
```

### Using HEREDOC for Multi-line

```bash
git commit -m "$(cat <<'EOF'
feat(reading): implement follow-up conversation

- Add chat endpoint for reading follow-ups
- Store conversation history in database
- Implement context windowing for long conversations

Closes #15
EOF
)"
```

## Commit Discipline

### Before Every Commit

1. **Run tests**: `make test` or `pytest` / `npm test`
2. **Run linters**: `make lint` or `ruff check` / `npm run lint`
3. **Run type check**: `make typecheck` or `mypy` / `npm run type-check`
4. **Review changes**: `git diff --staged`

### Commit Workflow

```bash
# Stage changes
git add .

# Review what's staged
git diff --staged

# Commit with conventional message
git commit -m "type(scope): description"

# If pre-commit hooks modify files, amend
git add .
git commit --amend --no-edit
```

### Commit Frequency

- **Commit after each logical unit of work**
- **Don't batch unrelated changes**
- **Commit working code** - broken commits make bisecting hard
- **Commit before switching context**

## Pull Request Process

### Creating a PR

```bash
# Push feature branch
git push -u origin feature/your-feature

# Create PR via GitHub CLI
gh pr create --title "feat(scope): description" --body "$(cat <<'EOF'
## Summary
Brief description of what this PR does.

## Changes
- Change 1
- Change 2

## Test Plan
- [ ] Unit tests added
- [ ] Manual testing completed
- [ ] Edge cases considered

## Related Issues
Closes #XX
EOF
)"
```

### PR Checklist

Before requesting review:

- [ ] Tests pass
- [ ] Linting passes
- [ ] Type checking passes
- [ ] Documentation updated if needed
- [ ] ADR created if architectural change
- [ ] No unnecessary files committed
- [ ] Commit messages follow conventions
- [ ] Branch is up to date with develop

### PR Title Format

Same as commit message: `type(scope): description`

## Merging

### Merge to Develop

```bash
# Ensure branch is up to date
git checkout feature/your-feature
git pull origin develop
git push

# Merge via PR (preferred) or locally
git checkout develop
git merge --no-ff feature/your-feature
git push origin develop

# Delete feature branch
git branch -d feature/your-feature
git push origin --delete feature/your-feature
```

### Release to Main

```bash
# From develop to main
git checkout main
git merge --no-ff develop
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin main --tags
```

## Handling Conflicts

```bash
# Update your branch with latest develop
git checkout feature/your-feature
git fetch origin
git rebase origin/develop

# If conflicts occur:
# 1. Resolve conflicts in each file
# 2. Stage resolved files
git add <resolved-file>
# 3. Continue rebase
git rebase --continue

# Force push (only on feature branches!)
git push --force-with-lease
```

## Git Configuration

### Recommended Global Config

```bash
# Set identity
git config --global user.name "Your Name"
git config --global user.email "your@email.com"

# Better defaults
git config --global pull.rebase true
git config --global fetch.prune true
git config --global diff.colorMoved zebra

# Helpful aliases
git config --global alias.st status
git config --global alias.co checkout
git config --global alias.br branch
git config --global alias.ci commit
git config --global alias.lg "log --oneline --graph --decorate"
```

### Project .gitignore

```gitignore
# Environment
.env
.env.local
.env.*.local

# Dependencies
node_modules/
__pycache__/
*.pyc
.venv/
venv/

# Build outputs
.next/
dist/
build/

# IDE
.idea/
.vscode/
*.swp

# OS
.DS_Store
Thumbs.db

# Testing
.coverage
htmlcov/
.pytest_cache/

# Logs
*.log
logs/
```

## Never Do

- **Never force push to main or develop**
- **Never commit secrets or credentials**
- **Never commit large binary files**
- **Never use `git add .` without reviewing**
- **Never commit with `-m "fix"` or similar lazy messages**
- **Never rewrite history on shared branches**

